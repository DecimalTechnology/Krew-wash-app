# Telr Payment Gateway Backend Integration Guide

## Overview
The Flutter app needs `tokenURL` and `orderURL` from your backend. These URLs are generated by calling Telr's API on your backend server.

## Backend Endpoint Required

### Endpoint: `POST /api/v1/payments/initialize`

### Request Body:
```json
{
  "amount": 12.1,
  "currency": "AED",
  "bookingData": {
    "package": {...},
    "addOns": [...],
    "dates": [...],
    "vehicle": {...},
    "totalAmount": 12.1
  }
}
```

### Backend Implementation (Node.js/Express Example):

```javascript
const express = require('express');
const axios = require('axios');
const crypto = require('crypto');

const router = express.Router();

// Telr Configuration
const TELR_STORE_ID = "25798";
const TELR_KEY = "Nbsw5^mDR5@3m9Nc";
const TELR_API_URL = "https://secure.telr.com/gateway/order.json"; // Test URL
// Production URL: https://secure.telr.com/gateway/order.json

// Generate Telr signature
function generateTelrSignature(params, key) {
  const sortedKeys = Object.keys(params).sort();
  const signatureString = sortedKeys
    .map(k => `${k}${params[k]}`)
    .join('');
  return crypto
    .createHash('md5')
    .update(key + signatureString)
    .digest('hex');
}

// POST /api/v1/payments/initialize
router.post('/payments/initialize', async (req, res) => {
  try {
    const { amount, currency, bookingData } = req.body;
    
    // Generate unique order reference
    const orderRef = `ORDER_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    
    // Prepare Telr order parameters
    const telrParams = {
      ivp_method: 'create',
      ivp_store: TELR_STORE_ID,
      ivp_authkey: TELR_KEY,
      ivp_amount: amount.toFixed(2),
      ivp_currency: currency,
      ivp_test: '1', // 1 for test, 0 for production
      ivp_cart: orderRef,
      ivp_desc: `Car Wash Booking - ${bookingData.package?.name || 'Service'}`,
      return_auth: 'https://your-backend.com/payments/success',
      return_can: 'https://your-backend.com/payments/cancel',
      return_decl: 'https://your-backend.com/payments/decline',
    };
    
    // Generate signature
    const signature = generateTelrSignature(telrParams, TELR_KEY);
    telrParams.ivp_signature = signature;
    
    // Call Telr API to create order
    const telrResponse = await axios.post(TELR_API_URL, telrParams, {
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
    });
    
    // Parse Telr response
    const telrData = telrResponse.data;
    
    if (telrData.order && telrData.order.ref) {
      // Extract tokenURL and orderURL from Telr response
      const tokenURL = telrData.order.token || telrData.order.url;
      const orderURL = telrData.order.url || telrData.order.ref;
      
      // Store order reference in database for later verification
      // await saveOrderReference(orderRef, bookingData, amount);
      
      return res.json({
        success: true,
        message: 'Payment initialized successfully',
        data: {
          tokenUrl: tokenURL,
          orderUrl: orderURL,
          orderRef: orderRef,
        },
      });
    } else {
      return res.status(400).json({
        success: false,
        message: telrData.error?.message || 'Failed to create Telr order',
      });
    }
  } catch (error) {
    console.error('Payment initialization error:', error);
    return res.status(500).json({
      success: false,
      message: 'Failed to initialize payment: ' + error.message,
    });
  }
});

module.exports = router;
```

## Alternative: Using Telr REST API

If Telr provides a REST API, you can use this approach:

```javascript
// POST /api/v1/payments/initialize
router.post('/payments/initialize', async (req, res) => {
  try {
    const { amount, currency, bookingData } = req.body;
    
    // Call Telr REST API
    const telrResponse = await axios.post(
      'https://secure.telr.com/gateway/mobile.json', // Check Telr docs for correct endpoint
      {
        store: TELR_STORE_ID,
        authkey: TELR_KEY,
        amount: amount,
        currency: currency,
        test: '1', // 1 for test mode
        // ... other required parameters
      },
      {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${TELR_KEY}`, // If required
        },
      }
    );
    
    // Extract tokenURL and orderURL
    const { tokenUrl, orderUrl } = telrResponse.data;
    
    return res.json({
      success: true,
      data: {
        tokenUrl: tokenUrl,
        orderUrl: orderUrl,
      },
    });
  } catch (error) {
    return res.status(500).json({
      success: false,
      message: error.message,
    });
  }
});
```

## Important Notes:

1. **Telr Credentials**: Store your Telr `storeId` and `key` securely on the backend (never in the app)

2. **Order Reference**: Generate a unique order reference for each payment

3. **Signature**: Telr requires an MD5 signature for security - generate it on the backend

4. **Test vs Production**:
   - Test mode: Use test credentials and test URLs
   - Production: Use production credentials and production URLs

5. **Callback URLs**: Set up callback URLs on your backend to handle:
   - Success: `/payments/success`
   - Cancel: `/payments/cancel`
   - Decline: `/payments/decline`

6. **Order Storage**: Store the order reference in your database to verify payment later

## Telr Documentation:
- Check Telr's official documentation for the exact API endpoints and parameters
- URL: https://docs.telr.com
- Contact Telr support for API credentials and integration details

## Testing:
1. Use Telr's test credentials
2. Test with small amounts
3. Verify the tokenURL and orderURL are valid HTTPS URLs
4. Test the payment flow end-to-end

